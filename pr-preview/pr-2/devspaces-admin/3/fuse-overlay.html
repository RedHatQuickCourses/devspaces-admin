<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuring the fuse-overlayfs Storage Driver :: Red Hat OpenShift Dev Spaces Administration</title>
    <link rel="prev" href="image-puller.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../..">Red Hat OpenShift Dev Spaces Administration</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/devspaces-admin/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="devspaces-admin" data-version="3">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Red Hat OpenShift Dev Spaces Administration</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Home</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="install.html">Install</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="operator.html">OpenShift Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli.html">CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitops.html">GitOps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="upgrade.html">Upgrade</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="remove.html">Uninstall</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="config.html">Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="che-cluster.html">CheCluster CR</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="image-puller.html">Image Puller</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="fuse-overlay.html">fuse-overlayfs</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat OpenShift Dev Spaces Administration</span>
    <span class="version">3</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Red Hat OpenShift Dev Spaces Administration</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">3</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Red Hat OpenShift Dev Spaces Administration</a></li>
    <li><a href="config.html">Configuration</a></li>
    <li><a href="fuse-overlay.html">fuse-overlayfs</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Configuring the fuse-overlayfs Storage Driver</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>By default, newly created workspaces that do not specify a <em>devfile</em> will use the <strong>Universal Developer Image (UDI)</strong> container image.</p>
</div>
<div class="paragraph">
<p>The <em>Universal Developer Image (UDI)</em> container image has <code>Podman</code> and <code>Buildah</code> tools pre-installed, which you can use to build and push container images within a workspace. However, Podman and Buildah in the UDI are configured to use the <code>vfs</code> storage driver which does not provide copy-on-write semantics in the workspace file system. For more efficient image management and better performance, you can configure the <code>fuse-overlayfs</code> storage driver, which supports copy-on-write semantics.</p>
</div>
<div class="paragraph">
<p>There are two ways you can enable <code>fuse-overlayfs</code> in Dev Spaces for improved performance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For workspaces that are already provisioned, and belonging to certain users</p>
</li>
<li>
<p>For all user workspaces within the cluster</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_enabling_fuse_overlayfs_for_specific_workspaces"><a class="anchor" href="#_lab_enabling_fuse_overlayfs_for_specific_workspaces"></a>Lab: Enabling fuse-overlayfs for Specific Workspaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this hands-on lab, you will enable the <code>fuse-overlayfs</code> storage driver for an already existing workspace.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to Dev Spaces dashboard as the <code>user1</code> user. Launch a new <code>Node.js Express</code> workspace from the dashboard.</p>
</li>
<li>
<p>Once the IDE loads fully, launch a new terminal by expanding the hamburger menu (three vertical bars), and then click <code>Terminal &gt; New Terminal</code></p>
<div class="imageblock">
<div class="content">
<img src="_images/launch-new-terminal.png" alt="launch new terminal">
</div>
<div class="title">Figure 1. Launch a new terminal in Workspace</div>
</div>
</li>
<li>
<p>Verify that by default, the <code>vfs</code> storage driver is used.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">web-nodejs-sample $ <strong>podman info | grep graphDriver</strong>
<em>graphDriverName: vfs</em></code></pre>
</div>
</div>
</li>
<li>
<p>Before enabling the <code>fuse-overlayfs</code> driver, you need to enable the <code>/dev/fuse</code> device for the workspace. Start off by using the <code>oc</code> client and log in as the <code>admin</code> user. List the workspaces for <code>user1</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>oc login -u admin</strong> <em>&lt;OpenShift API URL&gt;</em>
$ <strong>oc get devworkspace -n user1-devspaces</strong>
<em>NAME             DEVWORKSPACE ID             PHASE     INFO
nodejs-web-app   workspacee69523816d5c43c8   Running   https://...</em></code></pre>
</div>
</div>
</li>
<li>
<p>Patch the <code>nodejs-web-app</code> workspace to enable the <code>/dev/fuse</code> device.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc patch devworkspace nodejs-web-app -n user1-devspaces \
  --patch '{"spec":{"template":{"attributes":{"pod-overrides":{"metadata":{"annotations":{"io.kubernetes.cri-o.Devices":"/dev/fuse"}}}}}}}' \
  --type=merge
devworkspace.workspace.devfile.io/nodejs-web-app patched</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>/dev/fuse</code> device now exists in the workspace</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ stat /dev/fuse
File: /dev/fuse
Size: 0  Blocks: 0 IO Block: 4096 character special file
Device: ...
Access: ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If, however, you see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat: cannot statx '/dev/fuse': No such file or directory</code></pre>
</div>
</div>
<div class="paragraph">
<p>It means that the /dev/fuse device is not enabled, and the <code>fuse-overlayfs</code> storage driver will not work. Check that you have run the commands correctly as outlined in previous steps.</p>
</div>
</li>
<li>
<p>Next, to enable the <code>fuse-overlayfs</code> storage driver, inspect the contents of the <code>~/.config/containers/storage.conf</code> file, and note that Podman and Buildah in the workspace is configured to use the <code>vfs</code> driver by default:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">web-nodejs-sample $ cat ~/.config/containers/storage.conf
[storage]
driver = "vfs"</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>~/.config/containers/storage.conf</code> file inside the workspace and make the following changes (Use the <code>vi</code> or <code>vim</code> editor to make the changes):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[storage]
driver = "overlay"

[storage.options.overlay]
mount_program="/usr/bin/fuse-overlayfs"</code></pre>
</div>
</div>
</li>
<li>
<p>Delete some cached files using the old <code>vfs</code> driver</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">web-nodejs-sample $ rm -rf  ~/.local/share/containers/storage</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>fuse-overlayfs</code> storage driver is in use</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">web-nodejs-sample $ podman info | grep overlay
graphDriverName: overlay
overlay.mount_program:
  Executable: /usr/bin/fuse-overlayfs
  Package: fuse-overlayfs-1.13-1.module+el8.10.0+22202+761b9a65.x86_64
  fuse-overlayfs: version 1.13-dev
  Backing Filesystem: overlayfs</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now enabled the <code>fuse-overlayfs</code> storage driver in a running workspace. The manual steps to enable it are not optimal at scale. You need to enable the driver globally for all workspaces. One way to approach this, is to build a custom image and make all the configuration changes needed for the <code>fuse-overlayfs</code> storage driver. Another approach is to configure this globally in the <code>CheCluster</code> CR configuration so that all workspaces launched by users have this driver enabled by default. You will do so in the next lab.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_enabling_fuse_overlayfs_for_all_workspaces"><a class="anchor" href="#_lab_enabling_fuse_overlayfs_for_all_workspaces"></a>Lab: Enabling fuse-overlayfs for all Workspaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this hands-on lab, you will enable the <code>fuse-overlayfs</code> storage driver for all workspaces in the OpenShift cluster. You do this by creating a ConfigMap resource for the <code>storage.conf</code> file, and then mounting this configuration file (which enables the <code>fuse-overlayfs</code> storage driver) inside containers running in the workspace.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to OpenShift as the <code>admin</code> user using the `oc`client</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>oc login -u admin</strong> <em>&lt;OpenShift API URL&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Create a ConfigMap resource file named <code>fuse-overlayfs.yaml</code> that mounts the <code>storage.conf</code> file into containers running in a workspace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: ConfigMap
apiVersion: v1
metadata:
  name: fuse-overlay
  namespace: openshift-devspaces
  labels: <i class="conum" data-value="1"></i><b>(1)</b>
    app.kubernetes.io/part-of: che.eclipse.org
    app.kubernetes.io/component: workspaces-config
  annotations: <i class="conum" data-value="2"></i><b>(2)</b>
    controller.devfile.io/mount-as: subpath
    controller.devfile.io/mount-path: /home/user/.config/containers/
data: <i class="conum" data-value="3"></i><b>(3)</b>
  storage.conf: |
    [storage]
    driver = "overlay"

    [storage.options.overlay]
    mount_program="/usr/bin/fuse-overlayfs"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Labels to indicate that this configuration is related to workspace configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotations indicating the path inside the container where the storage.conf file must be mounted</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The actual storage.conf configuration file contents</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the ConfigMap</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc apply -f fuse-overlayfs.yaml
<em>configmap/fuse-overlay created</em></code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>devspaces</code> CheCluster instance (using the command <code>oc edit checluster/devspaces -n openshift-devspaces</code>) and enable the <code>/dev/fuse</code> device for all containers in workspaces, by adding the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: CheCluster
apiVersion: org.eclipse.che/v2
spec:
  <strong>devEnvironments:
    workspacesPodAnnotations:
      io.kubernetes.cri-o.Devices: /dev/fuse</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Log in as the <code>user1</code> user and launch an empty workspace from the dashboard. Launch a new terminal in the web IDE and first verify that the <code>/dev/fuse</code> device exists</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>stat /dev/fuse</strong>
File: /dev/fuse
Size: ...
Device: 700078h/7340152d...
...</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>storage.conf</code> configuration you provided in the ConfigMap is mounted inside the workspace</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>cat ~/.config/containers/storage.conf</strong>
[storage]
driver = "overlay"

[storage.options.overlay]
mount_program="/usr/bin/fuse-overlayfs"</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the <code>fuse-overlayfs</code> storage driver is in use</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ <strong>podman info | grep overlay</strong>
graphDriverName: overlay
overlay.mount_program:
  Executable: /usr/bin/fuse-overlayfs
  Package: fuse-overlayfs-1.13-1.module+el8.10.0+22202+761b9a65.x86_64
  fuse-overlayfs: version 1.13-dev
  Backing Filesystem: overlayfs</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="image-puller.html">Image Puller</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
