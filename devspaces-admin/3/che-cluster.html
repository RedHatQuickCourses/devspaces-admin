<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuring the CheCluster Custom Resource :: Red Hat OpenShift Dev Spaces Administration</title>
    <link rel="prev" href="config.html">
    <link rel="next" href="image-puller.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../..">Red Hat OpenShift Dev Spaces Administration</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/devspaces-admin/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="devspaces-admin" data-version="3">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Red Hat OpenShift Dev Spaces Administration</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Home</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="install.html">Install</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="operator.html">OpenShift Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli.html">CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitops.html">GitOps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="upgrade.html">Upgrade</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="remove.html">Uninstall</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="config.html">Configuration</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="che-cluster.html">CheCluster CR</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="image-puller.html">Image Puller</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fuse-overlay.html">fuse-overlayfs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="workspaces-cli.html">Managing Workspaces</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="storage.html">Workspace Storage</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat OpenShift Dev Spaces Administration</span>
    <span class="version">3</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Red Hat OpenShift Dev Spaces Administration</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">3</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Red Hat OpenShift Dev Spaces Administration</a></li>
    <li><a href="config.html">Configuration</a></li>
    <li><a href="che-cluster.html">CheCluster CR</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Configuring the CheCluster Custom Resource</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the previous sections, you have installed Dev Spaces and configured a default <code>CheCluster</code> (a Kubernetes Custom Resource, or CR) instance named <code>devspaces</code>. While you can customize this instance at installation time, it is commonly changed after you get a basic Dev Spaces instance up and running.</p>
</div>
<div class="paragraph">
<p>You configure Dev Spaces by creating or editing a YAML resource file for the <code>CheCluster</code> CR.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/checluster-cr-config.svg" alt="checluster cr config">
</div>
<div class="title">Figure 1. CheCluster YAML Change Process</div>
</div>
<div class="paragraph">
<p>The <code>CheCluster</code> YAML resource file contains sections to configure various <em>components</em>, the major ones being:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>devWorkspace</code></p>
</li>
<li>
<p><code>cheServer</code></p>
</li>
<li>
<p><code>pluginRegistry</code></p>
</li>
<li>
<p><code>devfileRegistry</code></p>
</li>
<li>
<p><code>dashboard</code></p>
</li>
<li>
<p><code>imagePuller</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Red Hat OpenShift Dev Spaces Operator parses and converts the <code>CheCluster</code> CR into a <code>ConfigMap</code> used by each component of the OpenShift Dev Spaces installation.</p>
</div>
<div class="paragraph">
<p>The OpenShift platform applies the configuration to each component, and creates the necessary Pods. When OpenShift detects changes in the configuration of a component, it restarts the Pods accordingly.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="https://docs.redhat.com/en/documentation/red_hat_openshift_dev_spaces/3.15/html-single/administration_guide/index#checluster-custom-resource-fields-reference" target="_blank" rel="noopener">CheCluster Custom Resource fields reference</a> for the full list of attributes and values that can be changed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_the_checluster_custom_resource_during_installation"><a class="anchor" href="#_configure_the_checluster_custom_resource_during_installation"></a>Configure the CheCluster Custom Resource during Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One approach to customizing the <code>CheCluster</code> CR at install time is to change the YAML configuration file directly, and then pass it to the <code>oc</code> CLI, or maintain it in a Git repository that is then picked up by ArgoCD and applied to the cluster.</p>
</div>
<div class="paragraph">
<p>Another approach to customize the CR at installation time is to provide the customization as a patch using a separate YAML file to the <code>dsc</code> CLI during installation.</p>
</div>
<div class="paragraph">
<p>For example, if you want to override the <code>cheServer</code> attribute from defaults and associate some extra OpenShift RBAC roles to the Dev Spaces server, create a <code>patch.yaml</code> file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  components:
    cheServer:
      clusterRoles:
        - a-role
        - b-role</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then apply the customization by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ dsc server:deploy \
  --che-operator-cr-patch-yaml=patch.yaml \
  -p openshift -n openshift-devspaces</code></pre>
</div>
</div>
<div class="paragraph">
<p>The operator will merge the configuration into the defaults and override the existing configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_configuring_the_checluster_custom_resource"><a class="anchor" href="#_lab_configuring_the_checluster_custom_resource"></a>Lab: Configuring the CheCluster Custom Resource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this short lab, you will restrict the number of Workspaces that an authenticated user can launch. By default, users can launch an unlimited number of Workspaces. You should restrict this parameter to a reasonable number to prevent abuse and overloading of your cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can view and modify the existing <code>CheCluster</code> instance configuration using the OpenShift web console, or with the <code>oc</code> CLI:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc edit checluster/devspaces -n openshift-devspaces</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although you can directly edit the YAML configuration using this approach, it is not recommended. A better approach is to maintain the YAML configuration in a version-controlled Git repository and then use GitOps techniques, or use the <code>oc replace -f &lt;filename.yaml&gt;</code> command.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have used the GitOps approach outlined previously, then ArgoCD is responsible for ensuring that the cluster state matches the configuration defined in the Git repository <code>main</code> branch. If you overwrite the <code>CheCluster</code> CR YAML using <code>oc</code> CLI or some other tool, then ArgoCD will reconcile the configuration and overwrite your changes!
</td>
</tr>
</table>
</div>
</li>
<li>
<p>View the current value for the <code>maxNumberOfWorkspacesPerUser</code> attribute of the CheCluster CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get checluster/devspaces \
  -n openshift-devspaces \
  -o jsonpath='{.spec.devEnvironments.maxNumberOfWorkspacesPerUser}'
<em>-1</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>-1</strong> value indicates unlimited Workspaces.</p>
</div>
</li>
<li>
<p>Inspect the <a href="https://github.com/RedHatQuickCourses/devspaces-apps/blob/main/gitops-config/devspaces/01-checluster-cr.yaml" class="bare">https://github.com/RedHatQuickCourses/devspaces-apps/blob/main/gitops-config/devspaces/01-checluster-cr.yaml</a> file in your forked Git repository. If you are using the GitOps approach, make the following changes to restrict the maximum number of workspaces per user to 5:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: org.eclipse.che/v2
kind: CheCluster
metadata:
  name: devspaces
  namespace: openshift-devspaces
...
spec:
  components:
    cheServer:
...
    dashboard:
...
  devEnvironments:
...
    <strong>maxNumberOfWorkspacesPerUser: 5</strong>
    secondsOfInactivityBeforeIdling: 1800</code></pre>
</div>
</div>
</li>
<li>
<p>Commit your changes back to your forked Git repository. Observe the ArgoCD dashboard and note that ArgoCD will detect the change and apply the change to the cluster. Run the <code>oc get checluster/devspaces</code> command from the previous step and note that the <code>maxNumberOfWorkspacesPerUser</code> has been updated to 5.</p>
</li>
<li>
<p>(<strong>OPTIONAL: Skip this step if you are using the GitOps approach</strong>). You can also modify the value of <code>maxNumberOfWorkspacesPerUser</code> using the <code>oc</code> CLI by running the <code>patch</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc patch checluster/devspaces \
  -n openshift-devspaces \
  --type='merge' -p  \
  '{"spec":{"devEnvironments":{"maxNumberOfWorkspacesPerUser": 5}}}'
<em>checluster.org.eclipse.che/devspaces patched</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>oc replace</code> command to modify a local copy of the YAML configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc replace -f \
  01-checluster-cr.yaml -n openshift-devspaces                                                                                                                                           ✔
<em>checluster.org.eclipse.che/devspaces replaced</em></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you are using GitOps and you run these commands, then you will not see the values updated even though the patch command says the resource has been patched! ArgoCD reconciles the value in milliseconds! This is to prevent accidental updates or changes. The configuration in the Git repository is the only place to change the values.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_optional_challenge_configure_the_maximum_number_of_simultaneously_running_workspaces_per_user"><a class="anchor" href="#_optional_challenge_configure_the_maximum_number_of_simultaneously_running_workspaces_per_user"></a>Optional Challenge: Configure the maximum number of simultaneously running workspaces per user.</h3>
<div class="paragraph">
<p>By default, a user is allowed to launch only <strong>one</strong> workspace at a time. If you try and launch more than 1 workspace for the same user, you will see an error:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/one-workspace-error.png" alt="Only one Workspace allowed to launch by default">
</div>
</div>
<div class="paragraph">
<p>You can increase this value by editing an attribute in the <code>CheCluster</code> CR. See <a href="https://docs.redhat.com/en/documentation/red_hat_openshift_dev_spaces/3.15/html-single/administration_guide/index#enabling-users-to-run-multiple-workspaces-simultaneously" class="bare">https://docs.redhat.com/en/documentation/red_hat_openshift_dev_spaces/3.15/html-single/administration_guide/index#enabling-users-to-run-multiple-workspaces-simultaneously</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make the necessary changes to the <code>CheCluster</code> CR YAML file.</p>
</li>
<li>
<p>Log in as <code>user1</code> to the Dev Spaces dashboard and launch any of the example workspaces listed on the home page.</p>
</li>
<li>
<p>Use a different browser, log in as <code>user1</code>, and launch one more example workspace to verify that you can launch more than one workspace.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="config.html">Configuration</a></span>
  <span class="next"><a href="image-puller.html">Image Puller</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
